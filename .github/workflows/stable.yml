name: Build stable kernel package

on:
  workflow_dispatch:
    inputs:
      release:
        type: choice
        description: Release type
        options:
          - none
          - pre-release
          - release

env:
  HOME: /home/runner
  KERNEL_STABLE_VER: 6.7.6
  PKGVER: 1

jobs:
    build:
      runs-on: self-hosted
      steps:
        - uses: actions/checkout@v4
        - name: Download linux kernel ${{ env.KERNEL_STABLE_VER }} source
          run: |
            wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.KERNEL_STABLE_VER }}.tar.xz \
              && tar xvf linux-${{ env.KERNEL_STABLE_VER }}.tar.xz

        - name: Setup dependencies
          run: |
            sudo apt-get update \
            && sudo apt-get install -y build-essential \
                 bc kmod cpio flex libncurses-dev \
                 libelf-dev libssl-dev dwarves bison \
                 gawk openssl libssl-dev dkms libudev-dev \
                 libpci-dev libiberty-dev autoconf \
                 debhelper lz4 gcc-14

        - name: Apply patch
          working-directory: linux-${{ env.KERNEL_STABLE_VER }}
          run: |
            git config user.name "GitHub Actions"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git clone --depth 1 https://gitlab.com/xanmod/linux-patches.git ../xanmod-patches \
             && for i in ../xanmod-patches/linux-6.7.y-xanmod/net/netfilter/*.patch \
                  ../xanmod-patches/linux-6.7.y-xanmod/net/tcp/bbr3/*.patch \
                  ../xanmod-patches/linux-6.7.y-xanmod/net/tcp/cloudflare/*.patch; do 
                    patch -Np1 -i ${i}
                done
            git clone https://github.com/clearlinux-pkgs/linux.git ../clear-patches \
             && for i in $(grep '^Patch' ../clear-patches/linux.spec |\
                  grep -Ev '^Patch0132|^Patch0118|^Patch0113|^Patch0138|^Patch0139' | sed -n 's/.*: //p'); do
                    patch -Np1 -i "../clear-patches/${i}"
                done
            curl -sSL https://gist.githubusercontent.com/love4taylor/111d56cd2b1dc149cba6d80f617f47b1/raw/1ea1a5df138c881d5b29ea1a02bb3e88f1ff9b4b/0001-net-tcp_brutal-make-it-as-a-built-in-kernel-module.patch | patch -Np1
            git clone --depth 1 --branch 6.7 https://anongit.gentoo.org/git/proj/linux-patches.git ../gentoo-patches \
             && patch -Np1 -i ../gentoo-patches/2930_gcc14-btrfs-fix-kvcalloc-args-order.patch \
             && patch -Np1 -i ../gentoo-patches/2931_gcc14-drm-i915-Adapt-to-Walloc-size.patch \
             && patch -Np1 -i ../gentoo-patches/2932_gcc14-objtool-Fix-calloc-call-for-new-Walloc-size.patch

        - name: Copy .config and setup some config
          working-directory: linux-${{ env.KERNEL_STABLE_VER }}
          run: |
            cp ../config .config
            scripts/config --set-str LOCALVERSION "-clear-bbrv3"
            # FULLCONENAT
            scripts/config -e NFT_FULLCONE
            # xt_FLOWOFFLOAD
            scripts/config -e NETFILTER_XT_TARGET_FLOWOFFLOAD
            # BBR3
            scripts/config -m TCP_CONG_CUBIC \
              -d DEFAULT_CUBIC \
              -e TCP_CONG_BBR \
              -e DEFAULT_BBR \
              --set-str DEFAULT_TCP_CONG bbr
            # BBR3 doesn't work properly with FQ_CODEL
            scripts/config -m NET_SCH_FQ_CODEL \
              -e NET_SCH_FQ \
              -d DEFAULT_FQ_CODEL \
              -e DEFAULT_FQ \
              --set-str DEFAULT_NET_SCH fq
            # TCP Brutal
            scripts/config -m TCP_CONG_BRUTAL
            # Disable DEBUG
            scripts/config -e DEBUG_INFO_NONE \
                           -d DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT \
                           -d DEBUG_INFO_DWARF4 \
                           -d DEBUG_INFO_DWARF5

        - name: Build
          working-directory: linux-${{ env.KERNEL_STABLE_VER }}
          env:
            DEBEMAIL: "love4taylor <i@love4taylor.com>"
            KDEB_COMPRESS: "xz"
          run: |
            make \
              CC="gcc-14" \
              HOSTCC="gcc-14" \
              olddefconfig
            make \
              KDEB_PKGVERSION=$(make kernelversion)-${{ env.PKGVER }} \
              CC="gcc-14" \
              HOSTCC="gcc-14" \
              -j`nproc` \
              bindeb-pkg
        
        - name: Upload config
          uses: actions/upload-artifact@v3
          with:
            name: config
            path: linux-${{ env.KERNEL_STABLE_VER }}/.config
        
        - name: Upload deb
          uses: actions/upload-artifact@v3
          with:
            name: deb
            path: linux-*.deb
        
        - name: Release
          if: ${{ github.event.inputs.release != 'none' }}
          uses: ncipollo/release-action@v1
          with:
            artifacts: linux-*.deb
            prerelease: ${{ github.event.inputs.release == 'pre-release' }}
            makeLatest: ${{ github.event.inputs.release == 'release' }}
            tag: ${{ env.KERNEL_STABLE_VER }}-${{ env.PKGVER }}

